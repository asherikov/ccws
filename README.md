Introduction
============

`colcon` (https://colcon.readthedocs.io/) template workspace for ROS
development and testing. This template integrates functionalities of
traditional workspaces and CI pipelines.


Features
--------

- Build profiles -- sets of configurations for build process, e.g., cmake
  toolchain, colcon configuration, environment variables, etc. Profiles do not
  conflict with each other and can be used simultaneously without using
  separate clones of the workspace and packages.

- Documentation generation for the whole workspace using `doxygen`, similar to
  https://github.com/mikepurvis/catkin_tools_document, but `doxygen`
  configuration and index html page are exposed and kept in the workspace.
  Example -> https://asherikov.github.io/ccws/example_staticoma/index.html

- Various static checks as in https://github.com/sscpac/statick, but with more
  flexibility (see `make/static_checks.mk`), in particular:
    - `cppcheck`
    - `catkin_lint` https://github.com/fkie/catkin_lint
    - `yamllint`
    - `shellcheck`
    - `clang-tidy` and `scan_build` via build profile, see below.

- Package template which demonstrates how to use some of the features.

- The number of parallel jobs can be selected based on available RAM instead of
  CPU cores, since RAM is more likely to be the limiting factor.

- Based entirely on `make` and shell scripts. All scripts are kept in the
  workspace and easy to adjust for specific needs.

- Cross-compilation support.


Profiles
--------

Profile configurations are located in `profiles`, currently availabale profiles are
- `reldebug` -- default profile, default compiler, cmake build type is
  `RelWithDebInfo`
- `scan_build` -- static checks with `scan_build` and `clang-tidy`.
  `clang-tidy` parameters are defined in cmake toolchain and must be enabled in
  packages as shown in package template. This profile also uses `clang` compiler.
- `thread_sanitizer` -- compilation with thread sanitizer.
- `addr_undef_sanitizers` -- compilation with address and undefined behavior
  sanitizers.
- `cross_raspberry_pi` -- crosscompilation for Raspberry Pi.

All profiles use `ccache`, but it can be disabled in cmake toolchains.

`common` subdirectory contains default parameters, which may be overriden by
build profiles.


Dependencies
------------

### Required
- `colcon`
- `wstool` -- it provides much more advanced features than `vcstool` which does
  not maintain package states locally.
- `cmake`

See `wsinstall_*` targets in `Makefile` for more info.


### Optional
- `doxygen`
- statick checkers, see `install_static_checkers` target in `make/static_checks.mk`
- `ccache`


### `scan_build` profile

`clang`, `scan_build` and `clang-tidy` for `scan_build` profile:
- apt install clang-tools-10 clang-tidy-10 clang-10



Usage
=====

Demo workspace is available in a branch of this repository ->
https://github.com/asherikov/ccws/tree/example_staticoma


Initial setup
-------------

- Edit `make/config.mk` to specify developer-dependent worskpace parameters.
- Install dependencies using `wsinstall_*` targets or manually.
- Clone pckages in `src` subdirectory, or create new using `make new PKG=<pkg>`.


Compilation
-----------

- `make build PKG="<pkg>"` where `<pkg>` is one or more space separated package names.
- `make <pkg>` -- a shortcut for `make build`, but the `<pkg>` can be a
  substring of package name. All packages matching the given substring will be built.
- The number of jobs can be overriden with `JOBS=X` parameter.
- `make build PKG=<pkg> PROFILE=scan_build` overrides default profile.


Running
-------

- Source `profiles/<profile>/setup.bash` to be able to use packages. Setup
  scripts generated by `colcon` can also be used directly, e.g.,
  `install/<profile>/setup.sh`, but in this case some of the workspace
  functionality won't be available.


Testing
-------
- `make test PKG=<pkg>` test with `colcon`.
- `make ctest PKG=<pkg>` bypass colcon and run `ctest` directly.


Documentation
-------------
- `make doxall`, `firefox artifacts/doxygen/index.html`


Crosscompilation (Raspberry Pi)
-------------------------------
1. install profile dependencies with `make install PROFILE=cross_raspberry_pi`
2. init workspace `make wsinit`
3. clone your repos to `src`, e.g., `cd src; git clone https://github.com/asherikov/staticoma.git`
4. add your repos to workspace `make wsscrape`
5. add ROS dependencies of all your packages to the workspace `make wsdep_to_rosinstall`,
   or a specific package `make dep_to_rosinstall PKG=<pkg>`
6. fetch all packages `make wsupdate`
7. mount sysroot with `make cross_raspberry_pi_mount` (see `profiles/cross_raspberry_pi/targets.mk`)
8. install system dependencies to the image `make cross_dep_install PKG=staticoma PROFILE=cross_raspberry_pi`
9. build packages, e.g. `make staticoma PROFILE=cross_raspberry_pi`
10. unmount sysroot when done with `make cross_raspberry_pi_umount`

See `doc/cross-compilation.md` for more details.


Related software
================

Related projects:
- https://github.com/ros-industrial/industrial_ci
- https://github.com/git-afsantos/haros
- https://github.com/DLu/roscompile
- https://github.com/asherikov/catkin_workspace [deprecated]
- https://github.com/ros-tooling/cross_compile/
