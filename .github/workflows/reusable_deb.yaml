# https://docs.github.com/en/actions/how-tos/reuse-automations/reuse-workflows
on:
    workflow_call:
        inputs:
            distro:
                required: false
                default: noble
                type: string
            build_target:
                required: false
                default: build_all
                type: string
            cloudsmith_repo:
                required: false
                default: ''
                type: string
            workspace_github_repo:
                required: false
                default: ${{ github.repository }}
                type: string
            workspace_version:
                required: false
                default: ${{ github.sha }}
                type: string
            package_version:
                required: false
                default: ''
                type: string
            package_github_repo:
                required: false
                default: ''
                type: string
        secrets:
            cloudsmith_token:
                required: false

defaults:
    run:
        working-directory: /ccws

env:
    WORKSPACE_SRC: ${GITHUB_WORKSPACE}
    PACKAGE_GITHUB_REPO_URL: ${{ github.server_url }}/${{ inputs.package_github_repo }}.git
    CCACHE_DISABLE: true

jobs:
    deb:
        runs-on: ubuntu-latest
        container:
            image: asherikov/ccws_${{ inputs.distro }}
            options: --security-opt seccomp:unconfined
        steps:
            - uses: actions/checkout@v5
              with:
                ref: ${{ inputs.workspace_version }}
                repository: ${{ inputs.workspace_github_repo }}
            - if: ${{ inputs.package_github_repo != '' }}
              run: |
                make set_repo_version REPO=${PACKAGE_GITHUB_REPO_URL} VERSION=${{ inputs.package_version }}
            - run: |
                make wsupdate_pkgs_shallow
                apt update
                make dep_install
                make ${{ inputs.build_target }} BUILD_PROFILE=deb,reldebug JOBS=2
              env:
                EMAIL: example@example.com
                AUTHOR: CI
            - run: |
                find ${WORKSPACE_DIR}/artifacts/ -iname *.deb
              shell: bash
            - if: ${{ inputs.distro == 'jammy' }}
              run: |
                python3 -m pip install cloudsmith-cli
            - if: ${{ inputs.distro != 'jammy' }}
              run: |
                python3 -m pip install --break-system-packages cloudsmith-cli
            - if: ${{ inputs.cloudsmith_repo != '' }}
              run: |
                find ${WORKSPACE_DIR}/artifacts/ -iname *.deb | xargs --no-run-if-empty -I {} cloudsmith push deb ${{ inputs.cloudsmith_repo }} {}
              env:
                CLOUDSMITH_API_KEY: ${{ secrets.cloudsmith_token }}
